{% load i18n %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% translate "Inventory Report" %}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <style>
      @page {
          size: A4;
          margin: 1.5cm;
          @bottom-right {
              content: "Page " counter(page) " of " counter(pages);
              font-family: Helvetica, sans-serif;
              font-size: 8pt;
          }
      }
      body {
        font-size: 0.875rem;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        font-family: Helvetica, sans-serif;
      }
      .custom-container {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-top: 30px;
        flex-grow: 1;
        margin-bottom: 30px;
      }
      .report-header {
        border-bottom: 2px solid #9cc666;
        padding-bottom: 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .report-header h1 {
        color: #545f71;
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
      }
      .report-meta {
        text-align: right;
        font-size: 0.85rem;
        color: #6c757d;
      }
      .section-title {
        color: #7a9f4f;
        border-bottom: 1px solid #9cc666;
        padding-bottom: 5px;
        margin-top: 30px;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 600;
      }

      /* Summary Boxes */
      .summary-card {
        background-color: #f8f9fa;
        border-left: 4px solid #9cc666;
        padding: 15px;
        border-radius: 4px;
        height: 100%;
      }
      .summary-card h5 {
        color: #9cc666;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .summary-card .number {
        font-size: 2rem;
        font-weight: bold;
        color: #545f71;
      }
      .summary-card .sub {
        font-size: 0.75rem;
        color: #6c757d;
      }

      /* Tables */
      .table-custom {
        width: 100%;
        margin-bottom: 1rem;
        border-collapse: collapse;
      }
      .table-custom th {
        background-color: #545f71;
        color: #fff;
        padding: 10px;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        border: none;
      }
      .table-custom td {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: top;
        color: #333;
      }
      .table-custom tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      /* Lot Header */
      .lot-header {
        background-color: #e9f2df; /* Light green tint */
        padding: 8px 15px;
        border-left: 4px solid #7a9f4f;
        margin-top: 25px;
        margin-bottom: 10px;
        border-radius: 0 4px 4px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        page-break-after: avoid;
      }
      .lot-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #3d4552;
        font-weight: bold;
      }
      .lot-count {
        font-size: 0.85rem;
        color: #545f71;
        background-color: #fff;
        padding: 2px 8px;
        border-radius: 10px;
      }

      /* Badges & Specs */
      .type-badge {
        background-color: #9cc666;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
        margin-bottom: 4px;
      }
      .spec-label {
        color: #7a9f4f;
        font-size: 0.7rem;
        font-weight: bold;
        text-transform: uppercase;
        margin-right: 4px;
      }
      .text-muted-custom {
        color: #6c757d;
        font-size: 0.8rem;
      }

      footer {
        background-color: #545f71;
        color: #ffffff;
        text-align: center;
        padding: 10px 0;
        margin-top: auto; /* Push to bottom */
      }
    </style>
  </head>
  <body>

    <div class="container custom-container">

      <div class="report-header">
        <div>
          <h1>{% translate "Inventory Report" %}</h1>
          <div style="font-size: 1.1rem; color: #7a9f4f; margin-top: 5px; font-weight: bold;">
            {{ institution.name }}
          </div>
        </div>
        <div class="report-meta">
          <div><strong>{% translate "Date:" %}</strong> {{ generated_at|date:"Y-m-d H:i" }}</div>
          <div><strong>{% translate "User:" %}</strong> {{ user.email }}</div>
        </div>
      </div>

      <h2 class="section-title">{% translate "Executive Summary" %}</h2>
      <div class="row mb-4">
        <div class="col-4">
          <div class="summary-card">
            <h5>{% translate "Total Assets" %}</h5>
            <div class="number">{{ total_devices }}</div>
            <div class="sub">
                {% for type, count in total_types_summary.items %}
                    {{ type }}: {{ count }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </div>
          </div>
        </div>
        <div class="col-4">
          <div class="summary-card">
            <h5>{% translate "Assigned" %}</h5>
            <div class="number">{{ assigned_devices }}</div>
            <div class="sub">{% widthratio assigned_devices total_devices 100 %}% {% translate "Utilization" %}</div>
          </div>
        </div>
        <div class="col-4">
          <div class="summary-card">
            <h5>{% translate "Unassigned" %}</h5>
            <div class="number">{{ unassigned_devices }}</div>
            <div class="sub">{% translate "Available stock" %}</div>
          </div>
        </div>
      </div>

      <div class="row mb-5">
        <div class="col-6">
            <h2 class="section-title">{% translate "Top Lots" %}</h2>
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>{% translate "Lot Name" %}</th>
                        <th style="text-align:right;">{% translate "Count" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lot in lots_summary|slice:":10" %}
                    <tr>
                        <td>{{ lot.name }}</td>
                        <td style="text-align:right;"><strong>{{ lot.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-6">
            <h2 class="section-title">{% translate "Device States" %}</h2>
            <table class="table-custom">
                <thead>
                    <tr>
                        <th>{% translate "State" %}</th>
                        <th style="text-align:right;">{% translate "Count" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for state in states_summary %}
                    <tr>
                        <td>{{ state.state }}</td>
                        <td style="text-align:right;"><strong>{{ state.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
      </div>

      <h2 class="section-title" style="page-break-before: always;">{% translate "Detailed Inventory Ledger" %}</h2>

      {% for lot_name, devices in devices_by_lot.items %}

        <div class="lot-header">
            <h3>{{ lot_name }}</h3>
            <span class="lot-count">{{ devices|length }} {% translate "items" %}</span>
        </div>

        <table class="table-custom">
            <thead>
                <tr>
                    <th width="18%">{% translate "ID / Serial" %}</th>
                    <th width="22%">{% translate "Device" %}</th>
                    <th width="35%">{% translate "Technical Specs" %}</th>
                    <th width="15%">{% translate "Status" %}</th>
                    <th width="10%">{% translate "Updated" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr>
                    <td>
                        <div style="font-family: monospace; background: #f3f3f3; padding: 2px 5px; display: inline-block; border-radius: 3px; font-weight: bold;">
                            {{ device.shortid }}
                        </div>
                        <div class="text-muted-custom mt-1">
                            {{ device.serial_number|default:"-"|truncatechars:15 }}
                        </div>
                    </td>

                    <td>
                        <span class="type-badge">{{ device.type }}</span><br>
                        <strong>{{ device.manufacturer }}</strong> {{ device.model }}
                    </td>

                    <td>
                        {% if "Laptop" in device.type or "Desktop" in device.type or "Server" in device.type %}
                            {% if device.cpu %}
                                <div><span class="spec-label">CPU</span> {{ device.cpu|truncatechars:30 }}</div>
                            {% endif %}
                            {% if device.total_ram %}
                                <div><span class="spec-label">RAM</span> {{ device.total_ram }}</div>
                            {% endif %}

                            {% for c in device.components %}
                                {% if c.type == "Storage" and c.size %}
                                    <div><span class="spec-label">DISK</span> {{ c.size }}</div>
                                {% endif %}
                            {% endfor %}

                        {% elif "Display" in device.type or "Monitor" in device.type %}
                            {% for p in device.get_properties %}
                                {% if "Native Resolution" in p.key or "resolution" in p.key|lower %}
                                    <div><span class="spec-label">RES</span> {{ p.value }}</div>
                                {% endif %}
                             {% endfor %}
                             {% for c in device.components %}
                                {% if c.type == "Display" and c.resolution %}
                                     <div><span class="spec-label">RES</span> {{ c.resolution }}</div>
                                {% endif %}
                             {% endfor %}

                        {% elif "HardDrive" in device.type or "SolidStateDrive" in device.type %}
                            {% for c in device.components %}
                                {% if c.type == "Storage" and c.size %}
                                    <div><span class="spec-label">CAPACITY</span> {{ c.size }}</div>
                                    {% if c.interface %}
                                        <div><span class="spec-label">IFACE</span> {{ c.interface }}</div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                        {% elif "RamModule" in device.type %}
                             {% for c in device.components %}
                                {% if c.type == "RamModule" %}
                                    <div><span class="spec-label">SIZE</span> {{ c.capacity|default:c.size }}</div>
                                    <div><span class="spec-label">TYPE</span> {{ c.memory_type|default:c.interface }}</div>
                                {% endif %}
                            {% endfor %}

                        {% else %}
                            <span style="color:#999;">-</span>
                        {% endif %}
                    </td>

                    <td>
                        {% with state=device.get_current_state %}
                            {% if state %}
                                {{ state.state }}
                            {% else %}
                                <span style="color:#999;">{% translate "Unknown" %}</span>
                            {% endif %}
                        {% endwith %}
                    </td>

                    <td style="font-size: 0.8rem;">
                        {{ device.updated|date:"Y-m-d" }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-bottom: 30px;"></div>
      {% endfor %}

    </div>

    <footer>
      <p>
        &copy; {% now 'Y' %} eReuse. All rights reserved.
      </p>
    </footer>

  </body>
</html>
