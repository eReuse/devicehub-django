{% extends "base.html" %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block content %}
<style>
  .drop-area {
    padding: 2rem;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }

  .drop-area:hover, .drop-area.dragover {
    border-color: #0d6efd;
    background: #e9ecef;
    transform: scale(1.01);
  }

  .drop-area i {
    color: #6c757d;
    transition: color 0.2s;
  }

  .drop-area:hover i {
    color: #0d6efd;
  }
</style>

<div class="container-fluid py-4 px-0">
    <form role="form" method="post" enctype="multipart/form-data" id="main-form">
        {% csrf_token %}

        {% if form.errors or attribute_formset.total_error_count %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {% trans "Please check the form for errors." %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <div class="alert alert-info d-flex align-items-center mb-4 shadow-sm" role="alert">
            <div>
                <strong>{% trans "Note:" %}</strong>
                {% trans "Providing a Custom ID or uploading an image limits creation to a single device." %}
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0 text-secondary">{% trans 'Device Information' %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                {% bootstrap_field form.type %}
                            </div>
                            <div class="col-md-4">
                                {% bootstrap_field form.amount %}
                            </div>
                            <div class="col-md-4">
                                {% bootstrap_field form.custom_id %}
                            </div>
                        </div>

                        <label class="form-label fw-bold">{% trans "Optional Photo Evidence" %}</label>
                        <div class="drop-area rounded p-5 text-center" id="drop-zone">
                          <i class="bi bi-upload fs-1 mb-3"></i>
                          <p class="mb-0">{% translate "Drag and drop here, or click to select manually" %}</p>
                          {{ form.photo_file }}
                        </div>

                        <div class="mt-3 text-center" id="image-preview" style="display: none;">
                            <div class="position-relative d-inline-block">
                                <img alt="Preview" class="img-fluid rounded border shadow-sm" id="preview-img"
                                     style="max-height: 250px; object-fit: contain;">
                                <p class="text-muted small mt-1 mb-0" id="preview-filename"></p>
                            </div>
                        </div>

                        {% if form.photo_file.errors %}
                        <div class="text-center text-danger mt-2">
                            {{ form.photo_file.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-secondary">{% trans 'Attributes' %}</h5>
                        <button type="button" id="add-form-btn" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-plus-lg"></i> {% trans 'Add Attribute' %}
                        </button>
                    </div>

                    <div class="card-body bg-light">
                        {{ attribute_formset.management_form }}

                        <div id="formset-container">
                            {% for form in attribute_formset %}
                                <div class="attribute-form-row row mb-2 g-2 align-items-center">
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    <div class="col-sm-5">
                                        {% bootstrap_field form.name show_label=False placeholder="Attribute Name" %}
                                    </div>
                                    <div class="col-sm-5">
                                        {% bootstrap_field form.value show_label=False placeholder="Value" %}
                                    </div>
                                    <div class="col-sm-2 text-center">
                                        {% if attribute_formset.can_delete %}
                                            <div class="d-none">{{ form.DELETE }}</div>
                                            <button type="button" class="btn btn-link text-danger remove-form-btn text-decoration-none">
                                                <i class="bi bi-trash fs-5"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                    {% if form.errors %}
                                        <div class="col-12 text-danger small ps-2">{{ form.errors }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 py-4 mt-2">
            <a class="btn btn-light border" href="{% url 'dashboard:unassigned' %}">{% translate "Cancel" %}</a>
            <button type="submit" class="btn btn-success px-5 shadow-sm">
                <i class="bi bi-check2-circle me-1"></i> {% translate "Save Device" %}
            </button>
        </div>
    </form>
</div>

<div id="empty-form" class="d-none">
    <div class="attribute-form-row row mb-2 g-2 align-items-center">
        <div class="col-sm-5">
            {% bootstrap_field attribute_formset.empty_form.name show_label=False placeholder="Attribute Name" %}
        </div>
        <div class="col-sm-5">
            {% bootstrap_field attribute_formset.empty_form.value show_label=False placeholder="Value" %}
        </div>
        <div class="col-sm-2 text-center">
            <div class="d-none">{{ attribute_formset.empty_form.DELETE }}</div>
            <button type="button" class="btn btn-link text-danger remove-form-btn text-decoration-none">
                <i class="bi bi-trash fs-5"></i>
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("file-input");
    const imagePreview = document.getElementById("image-preview");
    const previewImg = document.getElementById("preview-img");
    const previewFilename = document.getElementById("preview-filename");

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    ['dragover', 'dragleave', 'drop'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (event === 'dragover') {
                dropZone.classList.add('dragover');
            } else if (event === 'dragleave') {
                dropZone.classList.remove('dragover');
            } else if (event === 'drop') {
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;

                // Update file input manually
                fileInput.files = files;
                handleFiles(files);
            }
        });
    });

    function handleFiles(files) {
        if (!files.length) return;
        const file = files[0];

        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
                previewFilename.textContent = `${file.name} (${formatFileSize(file.size)})`;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            alert("Please upload a valid image file.");
            fileInput.value = "";
            imagePreview.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }


    // formset logic
    const formContainer = document.getElementById('formset-container');
    const addBtn = document.getElementById('add-form-btn');
    const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    const emptyFormTemplate = document.getElementById('empty-form').innerHTML;

    addBtn.addEventListener('click', function() {
        const formCount = parseInt(totalFormsInput.value);
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        formContainer.appendChild(tempDiv.firstElementChild);

        totalFormsInput.value = formCount + 1;
    });

    formContainer.addEventListener('click', function(e) {
        const btn = e.target.closest('.remove-form-btn');
        if (btn) {
            const row = btn.closest('.attribute-form-row');
            const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');

            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                row.classList.add('d-none');
            } else {
                row.remove();
            }
        }
    });
});
</script>
{% endblock %}
