{% extends "base.html" %}
{% load i18n %}

{% block content %}

<div class="row mb-4 g-4">

  <div class="col-md-6">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-3">
          <i class="bi bi-building me-2"></i> {% translate "Organization" %}
        </h5>
        <p class="card-text flex-grow-1">
          {% translate "Edit your organization's details." %}
        </p>
        <div class="text-end">
          <a href="{% url 'admin:institution' user.institution.pk %}" class="btn btn-outline-dark btn-sm d-inline-flex align-items-center">
            <span class="me-2">{% translate 'Edit' %}</span>
            <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-3">
          <i class="bi bi-sliders me-2"></i>{% translate "Settings" %}
        </h5>
        <p class="card-text flex-grow-1">
          {% translate "Manage your organization's settings." %}
        </p>
        <div class="text-end">
          <a href="{% url 'admin:institution_settings' user.institution.pk %}" class="btn btn-outline-dark btn-sm d-inline-flex align-items-center">
            <span class="me-2">{% translate 'Edit' %}</span>
            <i class="bi bi-arrow-right"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card h-100 shadow-sm border-0">
      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-3">
          <i class="bi bi-patch-check me-2"></i>{% translate "Digital Facility Record" %}
        </h5>
        <p class="card-text flex-grow-1">
          {% translate "Manage the Verifiable Credential for your facility." %}
        </p>

        <div class="d-flex justify-content-end align-items-center gap-2">

            <form id="dfr-issue-form" method="post" action="{% url 'admin:institution_dfr_issue' user.institution.pk %}">
                {% csrf_token %}
                <input type="hidden" name="latitude">
                <input type="hidden" name="longitude">

                <button type="submit"
                        class="btn btn-success btn-sm d-inline-flex align-items-center"
                        onclick="locateAndSubmit(event, this)">
                    <span>{% translate 'Issue' %}</span>
                </button>
            </form>

            {% with record=user.institution.latest_facility_credential %}
                {% if record %}
                    <a href="{% url 'evidence:credential_detail' pk=record.pk %}" class="btn btn-outline-dark btn-sm d-inline-flex align-items-center">
                        <span class="me-2">{% translate 'View' %}</span>
                        <i class="bi bi-arrow-right"></i>
                    </a>
                {% else %}
                    <button class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center" disabled>
                        <span class="me-2">{% translate 'View' %}</span>
                        <i class="bi bi-eye-slash"></i>
                    </button>
                {% endif %}
            {% endwith %}

        </div>
      </div>
    </div>
  </div>

</div>

<script>
    /**
     * Minimal JS to handle location injection and button state
     * keeping UX smooth and preventing layout shifts.
     */
    function locateAndSubmit(e, btn) {
        e.preventDefault();
        const form = document.getElementById('dfr-issue-form');

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{% translate "Locating..." %}';

        const doSubmit = () => form.submit();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    form.querySelector('[name="latitude"]').value = pos.coords.latitude;
                    form.querySelector('[name="longitude"]').value = pos.coords.longitude;
                    doSubmit();
                },
                (err) => {
                    console.warn("Location check failed, submitting without coords.");
                    doSubmit();
                },
                { timeout: 4000 }
            );
        } else {
            doSubmit();
        }
    }
</script>
{% endblock %}
